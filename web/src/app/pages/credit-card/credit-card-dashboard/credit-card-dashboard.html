<app-layout pageTitle="Cartões de Crédito">
  <div class="max-w-5xl mx-auto">
    <!-- Card Principal -->
    <div class="bg-white rounded-xl p-4 border border-border">
      <!-- Header -->
      <div class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-2">
          <lucide-icon name="CreditCard" size="20" class="text-primary"></lucide-icon>
          <span class="text-sm text-muted-foreground">Meus Cartões</span>
        </div>
        <a routerLink="/credit-card/request"
          class="flex items-center gap-2 bg-primary text-white text-xs px-4 py-2 rounded-lg transition-colors hover:brightness-105">
          <lucide-icon name="Plus" size="16" class="text-white"></lucide-icon>
          Solicitar Novo
        </a>
      </div>

      <div class="space-y-6">
        <!-- Lista de cartões com navegação -->
        @if (cards.length > 0) {
        <div>
          <h3 class="text-xs text-muted-foreground mb-4">Seus cartões</h3>
          
          <!-- Card Navigation -->
          <div class="flex items-center justify-between mb-4">
            <button
              class="w-10 h-10 border border-border rounded-lg flex items-center justify-center hover:bg-muted transition-colors disabled:opacity-50"
              (click)="previousCard()" [disabled]="currentCardIndex === 0">
              <svg class="w-5 h-5 text-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
            </button>

            <div class="flex gap-2">
              @for (card of cards; track card.id; let i = $index) {
              <div class="w-2 h-2 rounded-full transition-colors"
                [class.bg-gradient-start]="i === currentCardIndex" [class.bg-border]="i !== currentCardIndex">
              </div>
              }
            </div>

            <button
              class="w-10 h-10 border border-border rounded-lg flex items-center justify-center hover:bg-muted transition-colors disabled:opacity-50"
              (click)="nextCard()" [disabled]="currentCardIndex === cards.length - 1">
              <svg class="w-5 h-5 text-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </button>
          </div>

          <!-- Credit Card Display with Stack Effect -->
          <div class="relative h-56 max-w-sm mx-auto mb-4" style="min-height: 224px;">
            @for (card of cards; track card.id; let i = $index) {
              @if (i >= currentCardIndex && i <= currentCardIndex + 2) {
              <div 
                class="absolute w-full h-52 rounded-xl shadow-lg overflow-hidden transition-all duration-300 cursor-pointer"
                [style.z-index]="i === currentCardIndex ? 30 : (i === currentCardIndex + 1 ? 20 : 10)"
                [style.top.px]="i === currentCardIndex ? 0 : (i === currentCardIndex + 1 ? 20 : 40)"
                [style.left.px]="i === currentCardIndex ? 0 : (i === currentCardIndex + 1 ? 16 : 32)"
                [style.transform]="i === currentCardIndex ? 'scale(1)' : (i === currentCardIndex + 1 ? 'scale(0.92) translateY(12px) translateX(-4px)' : 'scale(0.84) translateY(24px) translateX(-8px)')"
                [style.opacity]="i === currentCardIndex ? 1 : (i === currentCardIndex + 1 ? 0.85 : 0.6)"
                (click)="selectCardByIndex(i, card)"
              >
                <div class="w-full h-full bg-gradient-to-r from-gradient-start to-gradient-end p-4 text-white">
                  <!-- Card Background Pattern -->
                  <div class="absolute top-0 right-0 w-20 h-20 bg-white opacity-10 rounded-full -translate-y-10 translate-x-10">
                  </div>
                  <div class="absolute bottom-0 left-0 w-16 h-16 bg-white opacity-5 rounded-full translate-y-8 -translate-x-8">
                  </div>

                  <!-- Card Content -->
                  <div class="relative z-10 h-full flex flex-col">
                    <!-- Card Header -->
                    <div class="flex justify-between items-start mb-2">
                      <div class="text-sm font-bold">{{ card.brand || 'CARD' }}</div>
                      <div class="text-xs font-medium">{{ formatExpiryDate(card) }}</div>
                    </div>

                    <!-- Card Number + Reveal Button -->
                    <div class="text-lg font-bold mb-2 tracking-wider flex-1 flex items-center gap-3">
                      <span>
                        {{ showFullNumber
                          ? formatFullCardNumber(card.cardNumber || card.maskedPan)
                          : formatCardNumber(card.maskedPan || card.cardNumber) }}
                      </span>
                      <button
                        class="text-[10px] font-medium px-2 py-1 rounded bg-white/15 hover:bg-white/25 transition"
                        type="button"
                        (click)="toggleShowNumber(); $event.stopPropagation()"
                        [attr.aria-pressed]="showFullNumber"
                        [title]="showFullNumber ? 'Ocultar número' : 'Mostrar número'"
                      >
                        {{ showFullNumber ? 'Ocultar' : 'Mostrar' }}
                      </button>
                    </div>

                    <!-- Card Footer -->
                    <div class="flex justify-between items-end">
                      <div>
                        <div class="text-xs opacity-80 mb-0.5">Limite Disponível</div>
                        <div class="text-xs font-bold">{{ formatCurrency(card.availableLimit) }}</div>
                      </div>
                      <div class="text-right">
                        <div class="text-xs font-bold">{{ getCardLogo(card.brand) }}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              }
            }
          </div>
        </div>
        }

        <!-- Resumo da fatura do cartão selecionado -->
        @if (selectedCard) {
        <div class="border-t border-border pt-6">
          <h3 class="text-xs text-muted-foreground mb-4">Resumo da Fatura</h3>
          <div class="bg-white rounded-xl p-4 border border-border">
            <div class="flex items-center justify-between mb-4">
              <div>
                <p class="text-xs text-muted-foreground">Cartão</p>
                <p class="text-sm font-medium text-text flex items-center gap-3">
                  <span>
                    {{ selectedCard.brand }} •
                    {{ showFullNumber
                      ? formatFullCardNumber(selectedCard.cardNumber || selectedCard.maskedPan)
                      : (selectedCard.maskedPan || '**** **** **** ' + (selectedCard.cardNumber | slice : -4)) }}
                  </span>
                  <button
                    class="text-[10px] font-medium px-2 py-1 rounded border border-border hover:bg-muted transition"
                    type="button"
                    (click)="toggleShowNumber()"
                    [attr.aria-pressed]="showFullNumber"
                    [title]="showFullNumber ? 'Ocultar número' : 'Mostrar número'"
                  >
                    {{ showFullNumber ? 'Ocultar' : 'Mostrar' }}
                  </button>
                </p>
              </div>
              <div class="text-right">
                <p class="text-xs text-muted-foreground">Fatura Atual</p>
                <p class="text-lg font-bold text-destructive">
                  {{ invoiceTotalBySelected | currency : 'BRL' }}
                </p>
              </div>
            </div>

            <app-invoice-summary 
              [items]="invoiceItems" 
              [loading]="invoiceLoading"
              [invoiceTotal]="invoiceTotalBySelected"
              [creditLimit]="selectedCardCreditLimit"
              [availableLimit]="selectedCardAvailableLimit">
            </app-invoice-summary>
          </div>
        </div>
        } @else {
        <div class="border-t border-border pt-6">
          <p class="text-xs text-muted-foreground text-center py-8">
            Selecione um cartão para ver a fatura.
          </p>
        </div>
        }

        <!-- Gastos recentes (somente cartão) -->
        <div class="border-t border-border pt-6">
          <app-credit-card-history></app-credit-card-history>
        </div>
      </div>
    </div>
  </div>
</app-layout>