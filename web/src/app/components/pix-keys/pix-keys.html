<div class="bg-white rounded-xl p-4 border border-border">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-2">
            <lucide-icon name="CreditCard" size="20" class="text-primary"></lucide-icon>
            <span class="text-sm text-muted-foreground">Chaves PIX</span>
        </div>
        <button (click)="toggleForm()"
            class="flex items-center gap-2 bg-primary text-white text-xs px-4 py-2 rounded-lg transition-colors"
            aria-label="Nova chave">
            <lucide-icon name="Plus" size="16" class="text-white"></lucide-icon>
            Nova Chave
        </button>
    </div>

    <div class="space-y-6">
        <!-- Account Selection Block -->
        <div class="bg-muted rounded-lg p-4 border border-border">
            <div class="text-xs text-muted-foreground mb-3">Selecione a conta</div>
            <div class="space-y-3">
                <div *ngFor="let account of userAccounts"
                    class="flex items-center gap-4 p-3 bg-white rounded-lg border border-border cursor-pointer transition-colors hover:bg-muted"
                    [class.border-primary]="selectedAccountId === account.id"
                    [class.bg-primary/5]="selectedAccountId === account.id" (click)="selectAccount(account)">

                    <!-- Icon -->
                    <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center">
                        <lucide-icon name="Wallet" size="20" class="text-primary"></lucide-icon>
                    </div>

                    <!-- Account Details -->
                    <div class="flex-1">
                        <div class="text-text text-sm font-semibold">{{ getAccountTypeLabel(account.accountType) }}
                        </div>
                        <div class="text-xs text-muted-foreground">{{ account.accountNumber }} (Ag: {{ account.agency
                            }})</div>
                    </div>

                    <!-- Balance -->
                    <div class="text-right">
                        <div class="font-semibold text-text text-sm">{{ formatBalance(account.balance) }}</div>
                        <div class="text-xs text-muted-foreground">Saldo</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Key Form Block -->
        <div *ngIf="showForm" class="bg-white rounded-lg p-4 border border-border">
            <div class="text-xs text-muted-foreground mb-4">Criar nova chave PIX</div>

            <div class="space-y-4">
                <!-- Selected Account Display -->
                <div *ngIf="selectedAccount" class="bg-muted rounded-lg p-3 border border-border">
                    <div class="text-xs text-muted-foreground mb-2">Conta selecionada</div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center">
                            <lucide-icon name="Wallet" size="18" class="text-primary"></lucide-icon>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-semibold text-text">{{
                                getAccountTypeLabel(selectedAccount.accountType) }}</div>
                            <div class="text-xs text-muted-foreground">{{ selectedAccount.accountNumber }}</div>
                        </div>
                        <div class="text-sm font-semibold text-text">{{ formatBalance(selectedAccount.balance) }}</div>
                    </div>
                </div>

                <!-- Key Type Selection -->
                <div>
                    <label class="block text-xs text-muted-foreground mb-2">Tipo de Chave</label>
                    <div class="space-y-2">
                        <div *ngFor="let type of keyTypes"
                            class="flex items-center justify-between p-3 bg-muted rounded-lg border border-border cursor-pointer transition-colors hover:bg-muted/80"
                            [class.border-primary]="pixForm.get('keyType')?.value === type.value"
                            [class.bg-primary/5]="pixForm.get('keyType')?.value === type.value"
                            (click)="selectKeyType(type.value)">

                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center">
                                    <lucide-icon
                                        [name]="type.value === 'EMAIL' ? 'CreditCard' : type.value === 'PHONE' ? 'Smartphone' : 'Wallet'"
                                        size="16" class="text-primary"></lucide-icon>
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-semibold text-text">{{ type.label }}</div>
                                    <div class="text-xs text-muted-foreground">{{ getTypeDescription(type.value) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Value Input -->
                <div *ngIf="pixForm.get('keyType')?.value">
                    <label class="block text-xs text-muted-foreground mb-2">Valor da Chave</label>
                    <input type="text" formControlName="keyValue" (input)="formatKeyValue($event)"
                        [placeholder]="getPlaceholderForKeyType()"
                        class="w-full px-4 py-3 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 bg-white"
                        [class.border-red-500]="pixForm.get('keyValue')?.invalid && pixForm.get('keyValue')?.touched">

                    <!-- Validation Messages -->
                    <div *ngIf="pixForm.get('keyValue')?.invalid && pixForm.get('keyValue')?.touched"
                        class="mt-2 flex items-center gap-2 text-xs text-red-600">
                        <lucide-icon name="AlertCircle" size="12" class="text-red-500"></lucide-icon>
                        <span>
                            <span *ngIf="pixForm.get('keyValue')?.errors?.['required']">Valor obrigatório</span>
                            <span *ngIf="pixForm.get('keyValue')?.errors?.['email']">E-mail inválido</span>
                            <span *ngIf="pixForm.get('keyValue')?.errors?.['pattern']">Formato inválido</span>
                        </span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button (click)="onSubmit()" [disabled]="pixForm.invalid || isLoading"
                        class="flex-1 bg-gradient-to-r from-primary to-secondary text-white font-medium py-3.5 px-6 rounded-lg hover:brightness-105 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center shadow-sm">
                        <span *ngIf="!isLoading">Criar Chave</span>
                        <span *ngIf="isLoading" class="flex items-center">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            Criando...
                        </span>
                    </button>
                    <button (click)="clearForm()" [disabled]="isLoading"
                        class="px-4 py-3.5 border border-border rounded-lg hover:bg-muted transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <lucide-icon name="X" size="16" class="text-muted-foreground"></lucide-icon>
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages Block -->
        <div *ngIf="errorMessage" class="bg-red-50 border border-red-200 rounded-lg p-4" role="alert">
            <div class="flex items-center gap-2">
                <lucide-icon name="AlertCircle" size="16" class="text-red-500"></lucide-icon>
                <span class="text-sm text-red-700">{{ errorMessage }}</span>
            </div>
        </div>

        <div *ngIf="successMessage" class="bg-green-50 border border-green-200 rounded-lg p-4" role="alert">
            <div class="flex items-center gap-2">
                <lucide-icon name="CheckCircle" size="16" class="text-green-500"></lucide-icon>
                <span class="text-sm text-green-700">{{ successMessage }}</span>
            </div>
        </div>

        <!-- Keys List Block -->
        <div *ngIf="selectedAccount && pixKeys.length > 0" class="bg-white rounded-lg p-4 border border-border">
            <div class="text-xs text-muted-foreground mb-4">Suas chaves PIX</div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                <div *ngFor="let key of pixKeys"
                    class="p-4 bg-white rounded-lg border border-border cursor-pointer transition-all duration-200 hover:bg-muted hover:border-primary/50 hover:shadow-md"
                    (click)="copyToClipboard(key)">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center">
                            <lucide-icon
                                [name]="key.keyType === 'EMAIL' ? 'CreditCard' : key.keyType === 'PHONE' ? 'Smartphone' : 'Wallet'"
                                size="16" class="text-primary"></lucide-icon>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-semibold text-text">{{ getKeyTypeLabel(key.keyType) }}</div>
                            <div class="text-xs text-muted-foreground">{{ key.createdAt | date:'dd/MM/yyyy' }}</div>
                        </div>
                    </div>
                    <div class="text-sm text-muted-foreground break-all leading-relaxed">
                        {{ formatKeyValueDisplay(key.keyValue, key.keyType) || 'Dados não disponíveis' }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State Block -->
        <div *ngIf="selectedAccount && pixKeys.length === 0 && !isLoading"
            class="bg-white rounded-lg p-8 border border-border text-center">
            <div class="w-16 h-16 bg-muted rounded-full flex items-center justify-center mx-auto mb-4">
                <lucide-icon name="CreditCard" size="24" class="text-muted-foreground"></lucide-icon>
            </div>
            <div class="text-sm text-muted-foreground mb-2">Nenhuma chave PIX cadastrada</div>
            <div class="text-xs text-muted-foreground">Clique em "Nova Chave" para criar sua primeira chave PIX</div>
        </div>

        <!-- No Accounts State Block -->
        <div *ngIf="userAccounts.length === 0 && !isLoading && !errorMessage"
            class="bg-white rounded-lg p-8 border border-border text-center">
            <div class="w-16 h-16 bg-muted rounded-full flex items-center justify-center mx-auto mb-4">
                <lucide-icon name="Wallet" size="24" class="text-muted-foreground"></lucide-icon>
            </div>
            <div class="text-sm text-muted-foreground mb-2">Nenhuma conta encontrada</div>
            <div class="text-xs text-muted-foreground">Crie uma conta para gerenciar suas chaves PIX</div>
        </div>

        <!-- Loading State Block -->
        <div *ngIf="isLoading" class="bg-white rounded-lg p-8 border border-border text-center">
            <div class="w-16 h-16 bg-muted rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="animate-spin h-6 w-6 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
            </div>
            <div class="text-sm text-muted-foreground">Carregando...</div>
        </div>
    </div>
</div>